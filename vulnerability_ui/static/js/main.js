// CipherGuard - AI Security Scanner JavaScript v2.0

let scanResults = null;
let eventSource = null;
let liveFindings = [];

document.addEventListener('DOMContentLoaded', function() {
    const scanBtn = document.getElementById('scanBtn');
    const toggleRawJson = document.getElementById('toggleRawJson');
    
    scanBtn.addEventListener('click', startScan);
    toggleRawJson.addEventListener('click', toggleJsonPanel);
    
    document.getElementById('repo').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            startScan();
        }
    });
    
    // Test Gemini connection on load
    testGeminiConnection();
});

async function testGeminiConnection() {
    const badge = document.getElementById('geminiBadge');
    try {
        const response = await fetch('/api/test_gemini');
        const data = await response.json();
        if (data.status === 'ok') {
            badge.innerHTML = '<i class="fas fa-check-circle"></i> <span>Connected to Gemini AI</span>';
            badge.classList.remove('disconnected', 'connecting');
            badge.classList.add('connected');
        } else {
            badge.innerHTML = '<i class="fas fa-exclamation-triangle"></i> <span>Gemini AI Disconnected</span>';
            badge.classList.remove('connected', 'connecting');
            badge.classList.add('disconnected');
        }
    } catch (e) {
        console.log('Gemini test failed:', e);
        badge.innerHTML = '<i class="fas fa-times-circle"></i> <span>Gemini AI Offline</span>';
        badge.classList.remove('connected', 'connecting');
        badge.classList.add('disconnected');
    }
}

function startScan() {
    const repoUrl = document.getElementById('repo').value.trim();
    const severity = document.getElementById('severity').value;
    
    if (!repoUrl) {
        showError('Please enter a valid GitHub repository URL');
        return;
    }
    
    if (!isValidGitHubUrl(repoUrl)) {
        showError('Please enter a valid GitHub repository URL (e.g., https://github.com/username/repo)');
        return;
    }
    
    // Reset state
    liveFindings = [];
    scanResults = null;
    
    // Show results section with loading state
    document.getElementById('resultsSection').style.display = 'block';
    document.getElementById('loadingState').style.display = 'block';
    document.getElementById('completedResults').style.display = 'none';
    document.getElementById('fileList').innerHTML = '';
    document.getElementById('progressContainer').innerHTML = '';
    
    // Disable scan button
    const scanBtn = document.getElementById('scanBtn');
    scanBtn.disabled = true;
    scanBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>Scanning...</span>';
    
    // Scroll to results
    document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
    
    // Close existing connection
    if (eventSource) {
        eventSource.close();
    }
    
    // Start SSE connection
    const url = `/scan_stream?repo=${encodeURIComponent(repoUrl)}&severity=${encodeURIComponent(severity)}`;
    eventSource = new EventSource(url);
    
    eventSource.addEventListener('status', function(e) {
        const data = JSON.parse(e.data);
        updateLoadingStatus(data.step, data.message, data.progress || 0);
    });
    
    eventSource.addEventListener('file_progress', function(e) {
        const data = JSON.parse(e.data);
        updateFileProgress(data);
    });
    
    eventSource.addEventListener('findings', function(e) {
        const data = JSON.parse(e.data);
        addLiveFindings(data);
    });
    
    eventSource.addEventListener('ai_progress', function(e) {
        const data = JSON.parse(e.data);
        updateAIProgress(data);
    });
    
    eventSource.addEventListener('ai_analysis', function(e) {
        const data = JSON.parse(e.data);
        addAIAnalysis(data);
    });
    
    eventSource.addEventListener('overall_assessment', function(e) {
        const data = JSON.parse(e.data);
        showOverallAssessment(data.assessment);
    });
    
    eventSource.addEventListener('error', function(e) {
        const data = JSON.parse(e.data);
        showError(data.error);
        eventSource.close();
        resetScanButton();
    });
    
    eventSource.addEventListener('ai_error', function(e) {
        const data = JSON.parse(e.data);
        console.warn('AI Error:', data.error);
    });
    
    eventSource.addEventListener('result', function(e) {
        const data = JSON.parse(e.data);
        eventSource.close();
        
        if (data.error) {
            showError(data.error);
            resetScanButton();
        } else {
            displayResults(data.result);
        }
    });
    
    eventSource.onerror = function(e) {
        console.error('EventSource error:', e);
        eventSource.close();
        showError('Connection lost. Please try again.');
        resetScanButton();
    };
}

function isValidGitHubUrl(url) {
    const pattern = /^https?:\/\/(www\.)?github\.com\/[\w.-]+\/[\w.-]+\/?$/;
    return pattern.test(url);
}

function updateLoadingStatus(step, message, progress) {
    document.getElementById('loadingTitle').textContent = step;
    document.getElementById('loadingSub').textContent = message;
    
    // Update progress bar
    let progressContainer = document.getElementById('progressContainer');
    if (!document.getElementById('mainProgress')) {
        progressContainer.innerHTML = `
            <div class="progress-wrapper">
                <div class="progress-bar-bg">
                    <div id="mainProgress" class="progress-bar-fill" style="width: 0%"></div>
                </div>
                <div class="progress-text">
                    <span id="progressPercent">0%</span>
                    <span id="progressStep">${step}</span>
                </div>
            </div>
        `;
    }
    
    document.getElementById('mainProgress').style.width = `${progress}%`;
    document.getElementById('progressPercent').textContent = `${progress}%`;
    document.getElementById('progressStep').textContent = step;
}

function updateFileProgress(data) {
    const fileList = document.getElementById('fileList');
    
    // Update or create file counter
    let counter = document.getElementById('fileCounter');
    if (!counter) {
        counter = document.createElement('div');
        counter.id = 'fileCounter';
        counter.className = 'file-counter';
        fileList.insertBefore(counter, fileList.firstChild);
    }
    counter.innerHTML = `<i class="fas fa-file-code"></i> Scanned: ${data.scanned} / ${data.total} files`;
    
    // Show current file being scanned
    let currentFile = document.getElementById('currentFile');
    if (!currentFile) {
        currentFile = document.createElement('div');
        currentFile.id = 'currentFile';
        currentFile.className = 'current-file';
        fileList.insertBefore(currentFile, counter.nextSibling);
    }
    currentFile.innerHTML = `<i class="fas fa-search"></i> ${escapeHtml(data.file)}`;
}

function addLiveFindings(data) {
    const fileList = document.getElementById('fileList');
    
    for (const finding of data.findings) {
        finding.file = data.file;
        liveFindings.push(finding);
        
        const item = document.createElement('div');
        item.className = `file-item severity-${finding.severity}`;
        item.innerHTML = `
            <i class="fas fa-exclamation-triangle"></i>
            <span class="file-name">${escapeHtml(data.file)}</span>
            <span class="finding-badge ${finding.severity}">${finding.severity.toUpperCase()}</span>
            <span class="finding-type">${escapeHtml(finding.keyword)}</span>
        `;
        fileList.appendChild(item);
        fileList.scrollTop = fileList.scrollHeight;
    }
    
    // Update live counter
    let liveCounter = document.getElementById('liveCounter');
    if (!liveCounter) {
        liveCounter = document.createElement('div');
        liveCounter.id = 'liveCounter';
        liveCounter.className = 'live-counter';
        fileList.insertBefore(liveCounter, fileList.firstChild);
    }
    liveCounter.innerHTML = `<i class="fas fa-bug"></i> Found: ${liveFindings.length} issues`;
}

function updateAIProgress(data) {
    document.getElementById('loadingTitle').textContent = 'AI Analysis';
    document.getElementById('loadingSub').textContent = `Analyzing ${data.finding} in ${data.file} (${data.current}/${data.total})`;
    
    document.getElementById('mainProgress').style.width = `${data.progress}%`;
    document.getElementById('progressPercent').textContent = `${data.progress}%`;
    document.getElementById('progressStep').textContent = `AI: ${data.current}/${data.total}`;
}

function addAIAnalysis(data) {
    const fileList = document.getElementById('fileList');
    
    const item = document.createElement('div');
    item.className = 'ai-analysis-item';
    item.innerHTML = `
        <div class="ai-finding-header">
            <i class="fas fa-robot"></i>
            <span>${escapeHtml(data.finding.file)} - ${escapeHtml(data.finding.keyword)}</span>
            <span class="finding-badge ${data.finding.severity}">${data.finding.severity.toUpperCase()}</span>
        </div>
        <div class="ai-analysis-content">${escapeHtml(data.analysis).substring(0, 200)}...</div>
    `;
    fileList.appendChild(item);
    fileList.scrollTop = fileList.scrollHeight;
}

function showOverallAssessment(assessment) {
    const fileList = document.getElementById('fileList');
    
    const item = document.createElement('div');
    item.className = 'overall-assessment-preview';
    item.innerHTML = `
        <div class="assessment-header">
            <i class="fas fa-clipboard-check"></i>
            <span>Overall Assessment Generated</span>
        </div>
    `;
    fileList.appendChild(item);
}

function displayResults(result) {
    scanResults = result;
    
    // Hide loading, show results
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('completedResults').style.display = 'block';
    
    // Populate stats
    const statsGrid = document.getElementById('statsGrid');
    const findings = result.findings || [];
    const severityCounts = result.severity_counts || { critical: 0, high: 0, medium: 0, low: 0 };
    
    statsGrid.innerHTML = `
        <div class="stat-card">
            <div class="stat-icon blue">
                <i class="fas fa-folder-open"></i>
            </div>
            <div class="stat-info">
                <div class="stat-value">${result.total_files_scanned || 0}</div>
                <div class="stat-label">Files Scanned</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon red">
                <i class="fas fa-skull-crossbones"></i>
            </div>
            <div class="stat-info">
                <div class="stat-value">${severityCounts.critical}</div>
                <div class="stat-label">Critical</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon yellow">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="stat-info">
                <div class="stat-value">${severityCounts.high}</div>
                <div class="stat-label">High</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon blue">
                <i class="fas fa-info-circle"></i>
            </div>
            <div class="stat-info">
                <div class="stat-value">${severityCounts.medium}</div>
                <div class="stat-label">Medium</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon green">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-info">
                <div class="stat-value">${severityCounts.low}</div>
                <div class="stat-label">Low</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon purple">
                <i class="fas fa-robot"></i>
            </div>
            <div class="stat-info">
                <div class="stat-value">${result.ai_analyses ? result.ai_analyses.length : 0}</div>
                <div class="stat-label">AI Analyzed</div>
            </div>
        </div>
    `;
    
    // Populate findings grouped by severity
    const findingsContainer = document.getElementById('findingsContainer');
    const noFindings = document.getElementById('noFindings');
    
    if (findings.length === 0) {
        findingsContainer.style.display = 'none';
        noFindings.style.display = 'block';
    } else {
        findingsContainer.style.display = 'flex';
        noFindings.style.display = 'none';
        
        // Group by severity
        const grouped = {
            critical: findings.filter(f => f.severity === 'critical'),
            high: findings.filter(f => f.severity === 'high'),
            medium: findings.filter(f => f.severity === 'medium'),
            low: findings.filter(f => f.severity === 'low')
        };
        
        let html = '';
        
        for (const [severity, items] of Object.entries(grouped)) {
            if (items.length > 0) {
                html += `<div class="severity-group">
                    <h4 class="severity-header ${severity}">
                        <i class="fas fa-${getSeverityIcon(severity)}"></i>
                        ${severity.toUpperCase()} (${items.length})
                    </h4>
                    <div class="severity-findings">`;
                
                for (const finding of items) {
                    const aiAnalysis = result.ai_analyses?.find(a => 
                        a.finding.file === finding.file && 
                        a.finding.keyword === finding.keyword &&
                        a.finding.line === finding.line
                    );
                    
                    html += createFindingCard(finding, aiAnalysis);
                }
                
                html += `</div></div>`;
            }
        }
        
        findingsContainer.innerHTML = html;
    }
    
    // Display AI Summary
    const aiSummarySection = document.getElementById('aiSummarySection');
    const aiSummaryContent = document.getElementById('aiSummaryContent');
    
    if (result.overall_assessment) {
        aiSummarySection.style.display = 'block';
        aiSummaryContent.innerHTML = formatAssessment(result.overall_assessment);
    } else {
        aiSummarySection.style.display = 'none';
    }
    
    // Set raw JSON
    document.getElementById('rawJson').textContent = JSON.stringify(result, null, 2);
    
    resetScanButton();
}

function getSeverityIcon(severity) {
    const icons = {
        critical: 'skull-crossbones',
        high: 'exclamation-triangle',
        medium: 'info-circle',
        low: 'check-circle'
    };
    return icons[severity] || 'question-circle';
}

function createFindingCard(finding, aiAnalysis) {
    return `
        <div class="finding-card">
            <div class="finding-header">
                <div class="finding-file">
                    <i class="fas fa-file-code"></i>
                    ${escapeHtml(finding.file)}
                </div>
                <span class="finding-badge ${finding.severity}">${finding.severity.toUpperCase()}</span>
            </div>
            <div class="finding-details">
                <div class="finding-detail">
                    <i class="fas fa-tag"></i>
                    <span>${escapeHtml(finding.keyword)}</span>
                </div>
                <div class="finding-detail">
                    <i class="fas fa-hashtag"></i>
                    <span>Line ${finding.line}</span>
                </div>
                <div class="finding-detail">
                    <i class="fas fa-info-circle"></i>
                    <span>${escapeHtml(finding.description)}</span>
                </div>
            </div>
            <div class="finding-match">${escapeHtml(finding.match)}</div>
            ${finding.context ? `<div class="finding-context"><code>${escapeHtml(finding.context)}</code></div>` : ''}
            ${aiAnalysis ? `
                <div class="ai-recommendation">
                    <div class="ai-rec-header">
                        <i class="fas fa-robot"></i> AI Analysis
                    </div>
                    <div class="ai-rec-content">${escapeHtml(aiAnalysis.analysis)}</div>
                </div>
            ` : ''}
        </div>
    `;
}

function formatAssessment(text) {
    // Convert markdown-like formatting to HTML
    return escapeHtml(text)
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/^### (.*$)/gim, '<h4>$1</h4>')
        .replace(/^## (.*$)/gim, '<h3>$1</h3>')
        .replace(/^# (.*$)/gim, '<h2>$1</h2>')
        .replace(/^\- (.*$)/gim, 'â€¢ $1<br>')
        .replace(/^\d+\. (.*$)/gim, '$&<br>')
        .replace(/\n/g, '<br>');
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function showError(message) {
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('completedResults').style.display = 'block';
    
    document.getElementById('statsGrid').innerHTML = `
        <div class="stat-card error-card" style="grid-column: 1 / -1;">
            <div class="stat-icon red">
                <i class="fas fa-exclamation-circle"></i>
            </div>
            <div class="stat-info">
                <div class="stat-value" style="font-size: 1rem; color: var(--accent-red);">${escapeHtml(message)}</div>
                <div class="stat-label">Error</div>
            </div>
        </div>
    `;
    
    document.getElementById('findingsContainer').innerHTML = '';
    document.getElementById('noFindings').style.display = 'none';
    document.getElementById('aiSummarySection').style.display = 'none';
}

function resetScanButton() {
    const scanBtn = document.getElementById('scanBtn');
    scanBtn.disabled = false;
    scanBtn.innerHTML = '<i class="fas fa-radar"></i> <span>Start Security Scan</span>';
}

function resetScan() {
    document.getElementById('resultsSection').style.display = 'none';
    document.getElementById('repo').value = '';
    document.getElementById('repo').focus();
    document.getElementById('rawJsonPanel').style.display = 'none';
    scanResults = null;
    liveFindings = [];
}

function copyResults() {
    if (!scanResults) return;
    
    const text = JSON.stringify(scanResults, null, 2);
    navigator.clipboard.writeText(text).then(() => {
        showToast('Results copied to clipboard!');
    }).catch(() => {
        showToast('Failed to copy results');
    });
}

function toggleJsonPanel() {
    const panel = document.getElementById('rawJsonPanel');
    const btn = document.getElementById('toggleRawJson');
    
    if (panel.style.display === 'none') {
        panel.style.display = 'block';
        btn.innerHTML = '<i class="fas fa-eye-slash"></i> Hide Raw JSON';
    } else {
        panel.style.display = 'none';
        btn.innerHTML = '<i class="fas fa-code"></i> View Raw JSON';
    }
}

function showToast(message) {
    const toast = document.createElement('div');
    toast.className = 'toast-message';
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.classList.add('fade-out');
        setTimeout(() => toast.remove(), 300);
    }, 2000);
}
